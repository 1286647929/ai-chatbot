# å¯¹è¯æµç¨‹æ¶æ„

æœ¬æ–‡æ¡£æè¿°äº† AI Chatbot é¡¹ç›®ä¸­å®Œæ•´çš„å¯¹è¯å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬å‰ç«¯äº¤äº’ã€API è·¯ç”±ã€ç¼–æ’å™¨æ‰§è¡Œå’Œå·¥å…·æ³¨å…¥æœºåˆ¶ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)
- [å„å±‚è¯¦ç»†è¯´æ˜](#å„å±‚è¯¦ç»†è¯´æ˜)
- [å…³é”®æ•°æ®æµæ€»ç»“](#å…³é”®æ•°æ®æµæ€»ç»“)

---

## æ¦‚è¿°

å¯¹è¯æµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªä¸»è¦å±‚çº§ï¼š

1. **å‰ç«¯å±‚ (Frontend)** - ç”¨æˆ·è¾“å…¥å’Œæ§åˆ¶å‚æ•°
2. **API å±‚ (Route)** - è¯·æ±‚å¤„ç†å’Œè·¯ç”±åˆ†æµ
3. **æ‰§è¡Œå±‚ (Execution)** - é»˜è®¤æ¨¡å¼ / æ³•å¾‹å¤šAgentæ¨¡å¼
4. **ç¼–æ’å±‚ (Orchestrator)** - æ„å›¾è¯†åˆ«å’ŒAgentè°ƒåº¦
5. **å·¥å…·æ³¨å…¥å±‚ (Tools)** - WebSearchæ§åˆ¶å’ŒMCPé›†æˆ
6. **å“åº”å±‚ (Response)** - æµå¼è¾“å‡ºå’Œæ•°æ®æŒä¹…åŒ–

---

## å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   å‰ç«¯å±‚ (Frontend)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   ç”¨æˆ·è¾“å…¥æ¶ˆæ¯    â”‚    â”‚  WebSearchToggle  â”‚    â”‚  AgentModeSelector   â”‚         â”‚
â”‚  â”‚  (MultimodalInput)â”‚    â”‚   [ğŸŒ å¼€/å…³]      â”‚    â”‚  [default | legal]   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                        â”‚                          â”‚                     â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                    â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Chat ç»„ä»¶ (useChat hook)                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  prepareSendMessagesRequest():                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  {                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    id: chatId,                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    message: { id, role: "user", parts: [...] },                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    selectedChatModel: "chat-model",                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    selectedVisibilityType: "private",                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    agentMode: "default" | "legal",        â—„â”€â”€ AgentModeSelector    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    webSearchEnabled: true | false         â—„â”€â”€ WebSearchToggle      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  }                                                                  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ POST /api/chat
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   API å±‚ (route.ts)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. è§£æè¯·æ±‚ä½“ (postRequestBodySchema.parse)                                 â”‚  â”‚
â”‚  â”‚  2. è®¤è¯æ£€æŸ¥ (auth())                                                        â”‚  â”‚
â”‚  â”‚  3. é€Ÿç‡é™åˆ¶æ£€æŸ¥                                                              â”‚  â”‚
â”‚  â”‚  4. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“                                                       â”‚  â”‚
â”‚  â”‚  5. åˆ¤æ–­æ‰§è¡Œè·¯å¾„:                                                             â”‚  â”‚
â”‚  â”‚     useLegalMultiAgent = agentMode === "legal" && ENABLE_MULTI_AGENT        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                    â”‚                               â”‚                                â”‚
â”‚          useLegalMultiAgent?                       â”‚                                â”‚
â”‚                    â”‚                               â”‚                                â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚            â–¼ YES         â–¼ NO              â”‚             â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚             â”‚                 â”‚             â”‚
             â–¼             â”‚                 â”‚             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è·¯å¾„ B: æ³•å¾‹å¤šAgent  â”‚ â”‚                 â”‚ â”‚       è·¯å¾„ A: é»˜è®¤å•Agentæ¨¡å¼           â”‚
â”‚   executeLegalMulti-   â”‚ â”‚                 â”‚ â”‚       executeDefaultStream              â”‚
â”‚   AgentStream          â”‚ â”‚                 â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚                 â”‚ â”‚                                        â”‚
â”‚                        â”‚ â”‚                 â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  æ„å»º AgentContext:    â”‚ â”‚                 â”‚ â”‚  â”‚  æ„å»ºå·¥å…·é›†:                      â”‚ â”‚
â”‚  {                     â”‚ â”‚                 â”‚ â”‚  â”‚  tools = {                       â”‚ â”‚
â”‚    chatId,             â”‚ â”‚                 â”‚ â”‚  â”‚    getWeather,                   â”‚ â”‚
â”‚    userId,             â”‚ â”‚                 â”‚ â”‚  â”‚    createDocument,               â”‚ â”‚
â”‚    userMessage,        â”‚ â”‚                 â”‚ â”‚  â”‚    updateDocument,               â”‚ â”‚
â”‚    messages,           â”‚ â”‚                 â”‚ â”‚  â”‚    requestSuggestions,           â”‚ â”‚
â”‚    metadata: {         â”‚ â”‚                 â”‚ â”‚  â”‚    ...(webSearchEnabled          â”‚ â”‚
â”‚      webSearchEnabled  â”‚ â”‚                 â”‚ â”‚  â”‚       ? { webSearch }            â”‚ â”‚
â”‚    }                   â”‚ â”‚                 â”‚ â”‚  â”‚       : {})                      â”‚ â”‚
â”‚  }                     â”‚ â”‚                 â”‚ â”‚  â”‚  }                               â”‚ â”‚
â”‚                        â”‚ â”‚                 â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                 â”‚ â”‚                                        â”‚
           â”‚               â”‚                 â”‚ â”‚  streamText({                          â”‚
           â–¼               â”‚                 â”‚ â”‚    model: chat-model,                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    tools,                              â”‚
â”‚        ç¼–æ’å±‚ (Orchestrator)              â”‚ â”‚ â”‚    experimental_activeTools           â”‚
â”‚        orchestrateStream                  â”‚ â”‚ â”‚  })                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚           â”‚                            â”‚
â”‚                                          â”‚ â”‚ â”‚           â–¼                            â”‚
â”‚  1. æ„å›¾è¯†åˆ« (routeToAgent)              â”‚ â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚  â”‚  æµå¼è¾“å‡ºåˆ° dataStream           â”‚ â”‚
â”‚     â”‚ classifyIntent(userMessage)    â”‚  â”‚ â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚     â”‚       â†“                        â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚     â”‚ determineAgents(intent)        â”‚  â”‚ â”‚                  â”‚
â”‚     â”‚       â†“                        â”‚  â”‚ â”‚                  â”‚
â”‚     â”‚ RoutingDecision {              â”‚  â”‚ â”‚                  â”‚
â”‚     â”‚   intent,                      â”‚  â”‚ â”‚                  â”‚
â”‚     â”‚   selectedAgents: AgentType[], â”‚  â”‚ â”‚                  â”‚
â”‚     â”‚   reason                       â”‚  â”‚ â”‚                  â”‚
â”‚     â”‚ }                              â”‚  â”‚ â”‚                  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚                  â”‚
â”‚                    â”‚                     â”‚ â”‚                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚                  â”‚
â”‚     â”‚                             â”‚     â”‚ â”‚                  â”‚
â”‚ selectedAgents                    â”‚     â”‚ â”‚                  â”‚
â”‚ .length === 0?                    â”‚     â”‚ â”‚                  â”‚
â”‚     â”‚                             â”‚     â”‚ â”‚                  â”‚
â”‚  â”Œâ”€â”€â”´â”€â”€â”                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”‚ â”‚                  â”‚
â”‚  â”‚ YES â”‚                    â”‚   NO    â”‚ â”‚ â”‚                  â”‚
â”‚  â–¼     â”‚                    â–¼         â”‚ â”‚ â”‚                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ é€šç”¨å¯¹è¯æ¨¡å¼  â”‚    â”‚      æ³•å¾‹ Agent æ‰§è¡Œæµç¨‹             â”‚ â”‚
â”‚ â”‚              â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ streamText({ â”‚    â”‚                                     â”‚ â”‚
â”‚ â”‚  model:      â”‚    â”‚  for (agentType of selectedAgents)  â”‚ â”‚
â”‚ â”‚  chat-model  â”‚    â”‚  {                                  â”‚ â”‚
â”‚ â”‚ })           â”‚    â”‚    streamAgent(agentType, context)  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  }                                  â”‚ â”‚
â”‚                     â”‚                                     â”‚ â”‚
â”‚                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚                     â”‚  â”‚  streamAgent å†…éƒ¨:              â”‚â”‚ â”‚
â”‚                     â”‚  â”‚                                 â”‚â”‚ â”‚
â”‚                     â”‚  â”‚  webSearchEnabled =             â”‚â”‚ â”‚
â”‚                     â”‚  â”‚    context.metadata             â”‚â”‚ â”‚
â”‚                     â”‚  â”‚    .webSearchEnabled            â”‚â”‚ â”‚
â”‚                     â”‚  â”‚                                 â”‚â”‚ â”‚
â”‚                     â”‚  â”‚  agent = createAgentInstance(   â”‚â”‚ â”‚
â”‚                     â”‚  â”‚    agentType,                   â”‚â”‚ â”‚
â”‚                     â”‚  â”‚    { webSearchEnabled }         â”‚â”‚ â”‚
â”‚                     â”‚  â”‚  )                              â”‚â”‚ â”‚
â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å·¥å…·æ³¨å…¥å±‚ (getToolsForAgent)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  async function getToolsForAgent(agentType, { webSearchEnabled }) {                 â”‚
â”‚                                                                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚  Step 1: è·å–åŸºç¡€å·¥å…·é›†                                                      â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚  â”‚  LEGAL_RESEARCH  â†’ legalResearchTools  (webSearch, regulationSearch) â”‚  â”‚  â”‚
â”‚    â”‚  â”‚  CASE_ANALYSIS   â†’ caseAnalysisTools   (webSearch, caseSearch)       â”‚  â”‚  â”‚
â”‚    â”‚  â”‚  LEGAL_ADVISOR   â†’ legalAdvisorTools   (webSearch, regulation, case) â”‚  â”‚  â”‚
â”‚    â”‚  â”‚  DOCUMENT_DRAFT  â†’ documentDraftTools  (templates, generator)        â”‚  â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                         â–¼                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚  Step 2: WebSearch æ§åˆ¶                                                      â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚  â”‚  if (!webSearchEnabled && "webSearch" in tools) {                    â”‚  â”‚  â”‚
â”‚    â”‚  â”‚    const { webSearch: _, ...rest } = tools;                          â”‚  â”‚  â”‚
â”‚    â”‚  â”‚    tools = rest;  // ç§»é™¤ webSearch                                   â”‚  â”‚  â”‚
â”‚    â”‚  â”‚  }                                                                    â”‚  â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                         â–¼                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚  Step 3: MCP å·¥å…·åˆå¹¶ (if ENABLE_MCP_TOOLS=true)                            â”‚  â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚  â”‚  const mcpTools = await getCachedMcpTools();  // 1åˆ†é’Ÿç¼“å­˜           â”‚  â”‚  â”‚
â”‚    â”‚  â”‚  if (Object.keys(mcpTools).length > 0) {                             â”‚  â”‚  â”‚
â”‚    â”‚  â”‚    tools = { ...tools, ...mcpTools };  // åˆå¹¶ MCP å·¥å…·               â”‚  â”‚  â”‚
â”‚    â”‚  â”‚  }                                                                    â”‚  â”‚  â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                         â–¼                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚  Step 4: è¿”å›æœ€ç»ˆå·¥å…·é›†                                                      â”‚  â”‚
â”‚    â”‚  return tools;  // æ³¨å…¥åˆ° Agent                                             â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å“åº”å±‚ (Response)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. Agent æ‰§è¡Œå¹¶æµå¼è¾“å‡º                                                      â”‚   â”‚
â”‚  â”‚     agent.stream({ context })                                                â”‚   â”‚
â”‚  â”‚           â†“                                                                  â”‚   â”‚
â”‚  â”‚     streamResult.toUIMessageStream({ sendReasoning: true })                  â”‚   â”‚
â”‚  â”‚           â†“                                                                  â”‚   â”‚
â”‚  â”‚     dataStream.merge(streamResult)                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                         â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. æ¶ˆæ¯ä¿å­˜                                                                  â”‚   â”‚
â”‚  â”‚     saveMessages({ messages, chatId })                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                         â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. SSE å“åº”è¿”å›å‰ç«¯                                                          â”‚   â”‚
â”‚  â”‚     stream.pipeThrough(new JsonToSseTransformStream())                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å‰ç«¯æ¥æ”¶ (Frontend Receive)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  useChat hook é€šè¿‡ SSE æ¥æ”¶æµå¼æ•°æ®:                                                  â”‚
â”‚                                                                                      â”‚
â”‚  onData: (dataPart) => {                                                            â”‚
â”‚    setDataStream([...dataStream, dataPart])                                         â”‚
â”‚                                                                                      â”‚
â”‚    dataPart.type:                                                                   â”‚
â”‚    â”œâ”€â”€ "text-delta"     â†’ æ›´æ–°æ¶ˆæ¯å†…å®¹                                              â”‚
â”‚    â”œâ”€â”€ "data-routing"   â†’ æ˜¾ç¤ºè·¯ç”±å†³ç­– (æ„å›¾ã€é€‰ä¸­Agent)                             â”‚
â”‚    â”œâ”€â”€ "data-agent-status" â†’ æ˜¾ç¤ºAgentæ‰§è¡ŒçŠ¶æ€                                      â”‚
â”‚    â””â”€â”€ "data-usage"     â†’ æ˜¾ç¤ºtokenä½¿ç”¨é‡                                           â”‚
â”‚  }                                                                                   â”‚
â”‚                                                                                      â”‚
â”‚  Messages ç»„ä»¶æ¸²æŸ“å¯¹è¯å†…å®¹                                                            â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å„å±‚è¯¦ç»†è¯´æ˜

### 1. å‰ç«¯å±‚ (Frontend)

**ç›¸å…³æ–‡ä»¶:**
- `components/chat.tsx` - ä¸»èŠå¤©ç»„ä»¶
- `components/multimodal-input.tsx` - è¾“å…¥ç»„ä»¶
- `components/web-search-toggle.tsx` - Webæœç´¢å¼€å…³
- `components/agent-mode-selector.tsx` - Agentæ¨¡å¼é€‰æ‹©å™¨

**æ ¸å¿ƒé€»è¾‘:**
```typescript
// Chat ç»„ä»¶ä¸­çš„çŠ¶æ€ç®¡ç†
const [webSearchEnabled, setWebSearchEnabled] = useState(true);
const [agentMode, setAgentMode] = useState<AgentModeType>("default");

// è¯·æ±‚ä½“æ„å»º
prepareSendMessagesRequest(request) {
  return {
    body: {
      id: request.id,
      message: request.messages.at(-1),
      selectedChatModel: currentModelIdRef.current,
      selectedVisibilityType: visibilityType,
      agentMode: agentModeRef.current,
      webSearchEnabled: webSearchEnabledRef.current,
    },
  };
}
```

### 2. API å±‚ (Route)

**ç›¸å…³æ–‡ä»¶:**
- `app/(chat)/api/chat/route.ts` - API è·¯ç”±
- `app/(chat)/api/chat/schema.ts` - è¯·æ±‚ä½“éªŒè¯

**è·¯ç”±åˆ†æµé€»è¾‘:**
```typescript
const useLegalMultiAgent =
  agentMode === AgentMode.LEGAL && shouldUseMultiAgentMode();

if (useLegalMultiAgent) {
  await executeLegalMultiAgentStream({ ..., webSearchEnabled });
} else {
  executeDefaultStream({ ..., webSearchEnabled });
}
```

### 3. ç¼–æ’å±‚ (Orchestrator)

**ç›¸å…³æ–‡ä»¶:**
- `lib/ai/orchestrator/index.ts` - ç¼–æ’å™¨
- `lib/ai/router/index.ts` - è·¯ç”±å†³ç­–

**Agent ç±»å‹:**
| Agent | è¯´æ˜ | å·¥å…·é›† |
|-------|------|--------|
| LEGAL_RESEARCH | æ³•å¾‹ç ”ç©¶ | webSearch, regulationSearch |
| CASE_ANALYSIS | æ¡ˆä¾‹åˆ†æ | webSearch, caseSearch |
| LEGAL_ADVISOR | æ³•å¾‹é¡¾é—® | webSearch, regulationSearch, caseSearch |
| DOCUMENT_DRAFT | æ–‡ä¹¦èµ·è‰ | templates, generator |

### 4. å·¥å…·æ³¨å…¥å±‚ (Tools)

**ç›¸å…³æ–‡ä»¶:**
- `lib/ai/tools/legal/index.ts` - æ³•å¾‹å·¥å…·é›†
- `lib/ai/tools/mcp/client.ts` - MCP å®¢æˆ·ç«¯

**å·¥å…·æ³¨å…¥æµç¨‹:**
1. è·å–åŸºç¡€å·¥å…·é›† (æ ¹æ® AgentType)
2. æ ¹æ® `webSearchEnabled` æ¡ä»¶ç§»é™¤/ä¿ç•™ webSearch
3. å¦‚æœ `ENABLE_MCP_TOOLS=true`ï¼Œåˆå¹¶ MCP å·¥å…·
4. è¿”å›æœ€ç»ˆå·¥å…·é›†æ³¨å…¥åˆ° Agent

---

## å…³é”®æ•°æ®æµæ€»ç»“

| é˜¶æ®µ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| **å‰ç«¯å‘é€** | `{ agentMode, webSearchEnabled, message }` | ç”¨æˆ·æ§åˆ¶çš„å‚æ•° |
| **è·¯ç”±åˆ†æµ** | `agentMode === "legal"?` | å†³å®šæ‰§è¡Œè·¯å¾„ |
| **é»˜è®¤æ¨¡å¼** | ç›´æ¥ `streamText()` | å·¥å…·ç”± `webSearchEnabled` æ§åˆ¶ |
| **æ³•å¾‹æ¨¡å¼** | `orchestrateStream()` | è¿›å…¥ç¼–æ’å™¨ |
| **æ„å›¾è¯†åˆ«** | `routeToAgent()` | è¿”å› Agent åˆ—è¡¨ |
| **å·¥å…·æ³¨å…¥** | `getToolsForAgent()` | åŸºç¡€å·¥å…· + WebSearchæ§åˆ¶ + MCPåˆå¹¶ |
| **Agentæ‰§è¡Œ** | `agent.stream()` | æµå¼è¾“å‡º |
| **å“åº”è¿”å›** | SSE æµ | å‰ç«¯å®æ—¶æ¸²æŸ“ |

---

## ç¯å¢ƒå˜é‡é…ç½®

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `ENABLE_MULTI_AGENT` | `true` | å¯ç”¨å¤šAgentæ¨¡å¼ |
| `ENABLE_MCP_TOOLS` | `false` | å¯ç”¨MCPå·¥å…·é›†æˆ |
| `AGENT_DEFAULT_TIMEOUT` | `60000` | Agentæ‰§è¡Œè¶…æ—¶(ms) |

---

## ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¦‚è¿°](./project-overview.md)
- [é¡¹ç›®ç»“æ„](./project-structure.md)
- [å¿«é€Ÿå‚è€ƒ](./quick-reference.md)
